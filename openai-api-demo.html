<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Generative AI Models for Text Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="openai-api-demo_files/libs/clipboard/clipboard.min.js"></script>
<script src="openai-api-demo_files/libs/quarto-html/quarto.js"></script>
<script src="openai-api-demo_files/libs/quarto-html/popper.min.js"></script>
<script src="openai-api-demo_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="openai-api-demo_files/libs/quarto-html/anchor.min.js"></script>
<link href="openai-api-demo_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="openai-api-demo_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="openai-api-demo_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="openai-api-demo_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="openai-api-demo_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Generative AI Models for Text Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This is intended as a simple demo for how one can make use of the OpenAI API in research, without running heavy computations on your own machine.</p>
<p>This notebook is heavily based on content from the <a href="https://cookbook.openai.com/">OpenAI cookbook</a>.</p>
<p>We will: 1. Locally load a dataset of food reviews. 2. Use the OpenAI API to create a numerical vector “embedding” for the reviews. 3. Use our machine to reduce the dimensionality, visualise, and cluster the reviews. 4. Use the OpenAI API to summarise the clusters we have found.</p>
<p>If you don’t have an OpenAI API key, you can still run this notebook, but you will not be able to use the API to generate embeddings or summaries and will have to rely on the pre-computed local results.</p>
<p>We only use simple models from OpenAI as a demo, but you can use the same approach to use more complex models.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<section id="sign-up-for-openai-api-access" class="level3">
<h3 class="anchored" data-anchor-id="sign-up-for-openai-api-access">1. Sign up for OpenAI API access</h3>
<p>OpenAI has developed various powerful Large Language Models. We can use the API to send data to these models and get back results. To do this, you will need to: 1. Sign up for an <a href="https://openai.com/product">account</a>. 2. Create an <a href="https://platform.openai.com/api-keys">API key</a> and save it (below). 3. Add your <a href="https://platform.openai.com/account/billing/overview">billing details</a> and top-up your account. This notebook costs a few cents to run.</p>
<p>If you just want to explore the results in this notebook, and not have to worry about setting up API access, set <code>USE_API = False</code> below.</p>
</section>
<section id="install-dependencies" class="level3">
<h3 class="anchored" data-anchor-id="install-dependencies">2. Install dependencies</h3>
<p>To run this notebook, you will need to install: <code>python-dotenv</code>, <code>pandas</code>, <code>openai</code>, <code>tiktoken</code>, <code>tenacity</code>, <code>matplotlib</code>, <code>scikit-learn</code>, and <code>scipy</code>.</p>
<p>Use <code>pip install</code> or <code>conda install</code> in your terminal to install these packages if they are not already present.</p>
</section>
<section id="setup-this-notebook-with-necessary-libraries-and-api-key" class="level3">
<h3 class="anchored" data-anchor-id="setup-this-notebook-with-necessary-libraries-and-api-key">3. Setup this notebook with necessary libraries and API key</h3>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;import utility libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ast <span class="im">import</span> literal_eval</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># import data analysis libraries</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.manifold <span class="im">import</span> TSNE</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># import plotting libraries</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># import OpenAI libraries</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tiktoken</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.embeddings_utils <span class="im">import</span> get_embedding <span class="co"># included in repo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Uncomment the following code to set up your OpenAI API key.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">## You will need to have an OpenAI account and have created an API key.</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">## You can do so here: https://platform.openai.com/api-keys</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">## You will only need to do this once. Afterwards, delete the cell</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # Load the environment variables from .env file</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># # Enter your API key, never share this or upload to GitHub</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # Make sure to add .env to your .gitignore file</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># api_key = "..."</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save the API key to .env file</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># with open(".env", "w") as f:</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     f.write(f"OPENAI_API_KEY={api_key}")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the environment variables (inc. API key) from .env file</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set whether to re-query the OpenAI API (True), or load data from disk (False)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>USE_API <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="get-embeddings-from-dataset-1" class="level2">
<h2 class="anchored" data-anchor-id="get-embeddings-from-dataset-1">Get embeddings from dataset <a href="https://github.com/openai/openai-cookbook/blob/main/examples/Get_embeddings_from_dataset.ipynb">[1]</a></h2>
<section id="load-the-dataset" class="level3">
<h3 class="anchored" data-anchor-id="load-the-dataset">1. Load the dataset</h3>
<p>The dataset used in this example is <a href="https://www.kaggle.com/snap/amazon-fine-food-reviews">fine-food reviews</a> from Amazon. The dataset contains a total of 568,454 food reviews Amazon users left up to October 2012. We will use a subset of this dataset, consisting of 1,000 most recent reviews for illustration purposes. The reviews are in English and tend to be positive or negative. Each review has a ProductId, UserId, Score, review title (Summary) and review body (Text).</p>
<p>We will combine the review summary and review text into a single combined text. The model will encode this combined text and it will output a single vector embedding. In layman’s terms, the model converts the human readable text of each review into a sequence of numbers. These numbers represent the meaning of the text. Reviews which are similar in meaning will have similar numbers in their embeddings and will be measurably ‘close’ to one another.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load &amp; inspect dataset</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>input_datapath <span class="op">=</span> <span class="st">"data/fine_food_reviews_1k.csv"</span>  <span class="co"># to save space, we provide a pre-filtered dataset</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(input_datapath, index_col<span class="op">=</span><span class="dv">0</span>) <span class="co"># read the csv</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">"Time"</span>, <span class="st">"ProductId"</span>, <span class="st">"UserId"</span>, <span class="st">"Score"</span>, <span class="st">"Summary"</span>, <span class="st">"Text"</span>]] <span class="co">#&nbsp;select specific columns</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna() <span class="co"># drop rows with missing values</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># combine title and content in a new column</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"combined"</span>] <span class="op">=</span> (<span class="st">"Title: "</span> <span class="op">+</span> df.Summary.<span class="bu">str</span>.strip()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                  <span class="op">+</span> <span class="st">"; Content: "</span> <span class="op">+</span> df.Text.<span class="bu">str</span>.strip())</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect the first five rows</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">ProductId</th>
<th data-quarto-table-cell-role="th">UserId</th>
<th data-quarto-table-cell-role="th">Score</th>
<th data-quarto-table-cell-role="th">Summary</th>
<th data-quarto-table-cell-role="th">Text</th>
<th data-quarto-table-cell-role="th">combined</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1351123200</td>
<td>B003XPF9BO</td>
<td>A3R7JR3FMEBXQB</td>
<td>5</td>
<td>where does one start...and stop... with a tre...</td>
<td>Wanted to save some to bring to my Chicago fam...</td>
<td>Title: where does one start...and stop... wit...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1351123200</td>
<td>B003JK537S</td>
<td>A3JBPC3WFUT5ZP</td>
<td>1</td>
<td>Arrived in pieces</td>
<td>Not pleased at all. When I opened the box, mos...</td>
<td>Title: Arrived in pieces; Content: Not pleased...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1351123200</td>
<td>B000JMBE7M</td>
<td>AQX1N6A51QOKG</td>
<td>4</td>
<td>It isn't blanc mange, but isn't bad . . .</td>
<td>I'm not sure that custard is really custard wi...</td>
<td>Title: It isn't blanc mange, but isn't bad . ....</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1351123200</td>
<td>B004AHGBX4</td>
<td>A2UY46X0OSNVUQ</td>
<td>3</td>
<td>These also have SALT and it's not sea salt.</td>
<td>I like the fact that you can see what you're g...</td>
<td>Title: These also have SALT and it's not sea s...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1351123200</td>
<td>B001BORBHO</td>
<td>A1AFOYZ9HSM2CZ</td>
<td>5</td>
<td>Happy with the product</td>
<td>My dog was suffering with itchy skin. He had ...</td>
<td>Title: Happy with the product; Content: My dog...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify embedding model parameters</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>embedding_model <span class="op">=</span> <span class="st">"text-embedding-ada-002"</span> <span class="co"># more options here: https://platform.openai.com/docs/guides/embeddings/embedding-models</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>embedding_encoding <span class="op">=</span> <span class="st">"cl100k_base"</span>  <span class="co"># this the encoding for text-embedding-ada-002</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>max_tokens <span class="op">=</span> <span class="dv">8000</span>  <span class="co"># the maximum for text-embedding-ada-002 is 8191</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># subsample to 1k most recent reviews and remove samples that are too long</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>top_n <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sort_values(<span class="st">"Time"</span>).tail(top_n <span class="op">*</span> <span class="dv">2</span>)  <span class="co"># first cut to first 2k entries</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>df.drop(<span class="st">"Time"</span>, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>) <span class="co"># drop time column</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>encoding <span class="op">=</span> tiktoken.get_encoding(embedding_encoding) <span class="co"># get the encoding</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># omit reviews that are too long to embed</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># get the number of tokens in each review according to the encoding</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"n_tokens"</span>] <span class="op">=</span> df[<span class="st">"combined"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(encoding.encode(x))) </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df[<span class="st">"n_tokens"</span>] <span class="op">&lt;=</span> max_tokens].tail(top_n) <span class="co"># drop reviews that are too long, then take the last top_n entries</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>1000</code></pre>
</div>
</div>
</section>
<section id="get-embeddings-and-save-them-for-future-reuse" class="level3">
<h3 class="anchored" data-anchor-id="get-embeddings-and-save-them-for-future-reuse">2. Get embeddings and save them for future reuse</h3>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Query the OpenAI API to get the embeddings</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This may take a few minutes</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This also costs money (several cents with default settings) from your OpenAI API balance</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set USE_API to False to load the embeddings from disk instead</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> USE_API:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Querying the OpenAI API to get the embeddings..."</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"embedding"</span>] <span class="op">=</span> df[<span class="st">"combined"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: get_embedding(x, model<span class="op">=</span>embedding_model))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    df.to_csv(<span class="st">"data/fine_food_reviews_with_embeddings_1k.csv"</span>) <span class="co"># save the data to disk</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Loading the embeddings from disk..."</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(<span class="st">"data/fine_food_reviews_with_embeddings_1k.csv"</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"embedding"</span>] <span class="op">=</span> df[<span class="st">"embedding"</span>].<span class="bu">apply</span>(literal_eval) <span class="co"># convert string to list in embedding column</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading the embeddings from disk...</code></pre>
</div>
</div>
</section>
</section>
<section id="visualizing-the-embeddings-in-2d-2" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-the-embeddings-in-2d-2">Visualizing the embeddings in 2D <a href="https://github.com/openai/openai-cookbook/blob/main/examples/Visualizing_embeddings_in_2D.ipynb">[2]</a></h2>
<p>We will use t-SNE, a common dimension reduction technique, to visualize the embeddings in 2D (rather than the original 1536 dimensions). Once the embeddings are reduced to two dimensions, we can plot them in a 2D scatter plot.</p>
<section id="reduce-dimensionality" class="level3">
<h3 class="anchored" data-anchor-id="reduce-dimensionality">1. Reduce dimensionality</h3>
<p>We reduce the dimensionality to 2 dimensions using t-SNE decomposition.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert embedding scores in df to an array of floats</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>matrix <span class="op">=</span> np.array(df[<span class="st">"embedding"</span>].to_list())</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a t-SNE model and transform the data</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>tsne <span class="op">=</span> TSNE(n_components<span class="op">=</span><span class="dv">2</span>, perplexity<span class="op">=</span><span class="dv">15</span>, random_state<span class="op">=</span><span class="dv">42</span>, init<span class="op">=</span><span class="st">'random'</span>, learning_rate<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>vis_dims <span class="op">=</span> tsne.fit_transform(matrix) <span class="co">#&nbsp;transform the data</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>vis_dims.shape <span class="co">#&nbsp;check the shape of the output - 1000 obs, 2 dimensions</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>(1000, 2)</code></pre>
</div>
</div>
</section>
<section id="plotting-the-embeddings" class="level3">
<h3 class="anchored" data-anchor-id="plotting-the-embeddings">2. Plotting the embeddings</h3>
<p>We colour each review by its star rating.</p>
<p>We can observe a decent data separation, albeit not by rating, even in the reduced 2 dimensions.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># colors for star ratings</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">"black"</span>, <span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"orange"</span>, <span class="st">"green"</span>]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> vis_dims[:,<span class="dv">0</span>] <span class="co"># x and y coordinates</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> vis_dims[:,<span class="dv">1</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>color_indices <span class="op">=</span> df.Score.values <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>colormap <span class="op">=</span> matplotlib.colors.ListedColormap(colors) <span class="co"># create a colormap from the colors</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, c<span class="op">=</span>color_indices, cmap<span class="op">=</span>colormap, alpha<span class="op">=</span><span class="fl">0.3</span>) <span class="co"># plot the data</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># add cluster centers</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> score <span class="kw">in</span> [<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>]:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    avg_x <span class="op">=</span> x[df[<span class="st">"Score"</span>]<span class="op">-</span><span class="dv">1</span><span class="op">==</span>score].mean()</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    avg_y <span class="op">=</span> y[df[<span class="st">"Score"</span>]<span class="op">-</span><span class="dv">1</span><span class="op">==</span>score].mean()</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> colors[score]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    plt.scatter(avg_x, avg_y, marker<span class="op">=</span><span class="st">'x'</span>, color<span class="op">=</span>color, s<span class="op">=</span><span class="dv">100</span>, label <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>score<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">-star'</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Amazon ratings visualized in language using t-SNE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>Text(0.5, 1.0, 'Amazon ratings visualized in language using t-SNE')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="openai-api-demo_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The major visible clusters don’t seem to be associated with the star rating. This is expected, as the model is trained to encode the meaning of the text, not the star rating or solely sentiment. There is perhaps some hyperlocal clustering in certain cases, but it is not very clear. Let’s see what the apparent clusters actually relate to…</p>
</section>
</section>
<section id="k-means-clustering-in-python-using-openai-3" class="level2">
<h2 class="anchored" data-anchor-id="k-means-clustering-in-python-using-openai-3">K-means Clustering in Python using OpenAI <a href="https://github.com/openai/openai-cookbook/blob/main/examples/Clustering.ipynb">[3]</a></h2>
<p>We use a simple k-means algorithm to demonstrate how clustering can be done. Clustering can help discover valuable, hidden groupings within the data. We cluster based on all 1536 dimensions of the embeddings. Then we plot the clusters in 2D using t-SNE.</p>
<section id="find-the-clusters-using-k-means" class="level3">
<h3 class="anchored" data-anchor-id="find-the-clusters-using-k-means">1. Find the clusters using K-means</h3>
<p>We show the simplest use of K-means. You can pick the number of clusters that fits your use case best.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>n_clusters <span class="op">=</span> <span class="dv">4</span> <span class="co"># decide on the number of clusters</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the k-means model</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>kmeans <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>n_clusters, init<span class="op">=</span><span class="st">"k-means++"</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>kmeans.fit(matrix)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> kmeans.labels_</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"Cluster"</span>] <span class="op">=</span> labels <span class="co">#&nbsp;add the cluster labels to the dataframe</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>df.groupby(<span class="st">"Cluster"</span>)[<span class="st">"Score"</span>].mean().sort_values() <span class="co">#&nbsp;check the average star rating per cluster</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/Patrick/Documents/LSE/Projects/genai-tools/.venv/lib/python3.11/site-packages/sklearn/cluster/_kmeans.py:1416: FutureWarning: The default value of `n_init` will change from 10 to 'auto' in 1.4. Set the value of `n_init` explicitly to suppress the warning
  super()._check_params_vs_input(X, default_n_init=10)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>Cluster
3    4.046809
1    4.191176
2    4.212687
0    4.340720
Name: Score, dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># using t-SNE dimensions from before (x, y)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot each cluster in different colour</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> category, color <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"purple"</span>, <span class="st">"green"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>]):</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> x[df[<span class="st">"Cluster"</span>] <span class="op">==</span> category]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    ys <span class="op">=</span> y[df[<span class="st">"Cluster"</span>] <span class="op">==</span> category]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    plt.scatter(xs, ys, color<span class="op">=</span>color, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add cluster center</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    avg_x <span class="op">=</span> xs.mean()</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    avg_y <span class="op">=</span> ys.mean()</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    plt.scatter(avg_x, avg_y, marker<span class="op">=</span><span class="st">"x"</span>, color<span class="op">=</span>color, s<span class="op">=</span><span class="dv">100</span>, label<span class="op">=</span><span class="ss">f'Cluster </span><span class="sc">{</span>category<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Clusters identified visualized in language 2d using t-SNE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>Text(0.5, 1.0, 'Clusters identified visualized in language 2d using t-SNE')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="openai-api-demo_files/figure-html/cell-12-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Visualization of clusters in a 2d projection. In this run, the green cluster (#1) seems quite different from the others. Let’s see a few samples from each cluster.</p>
</section>
<section id="text-samples-in-the-clusters-naming-the-clusters" class="level3">
<h3 class="anchored" data-anchor-id="text-samples-in-the-clusters-naming-the-clusters">2. Text samples in the clusters &amp; naming the clusters</h3>
<p>Let’s show random samples from each cluster. We’ll query OpenAI API again, with model <code>text-davinci-003</code>, to decribe the clusters, based on a random sample of 5 reviews from that cluster. More reviews or a more sophisticated model (<code>gpt-4</code>, <code>gpt-3.5-turbo</code>) can be used to get a better description, since the default descriptions are quite generic.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> USE_API: <span class="co"># Query the OpenAI API to get the theme for each cluster</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This also costs money (several cents with default settings) from your OpenAI API balance</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a dictionary to save the results</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    summary_dict <span class="op">=</span> {n<span class="op">+</span><span class="dv">1</span>: {} <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(n_clusters)}</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create OpenAI API client</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> OpenAI()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    rev_per_cluster <span class="op">=</span> <span class="dv">5</span> <span class="co"># Select 5 random reviews per cluster</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_clusters): <span class="co"># for each cluster</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sample 5 random reviews from the cluster, combine them into a single string</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        reviews <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>            df[df[<span class="st">"Cluster"</span>] <span class="op">==</span> i]</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>            .combined.<span class="bu">str</span>.replace(<span class="st">"Title: "</span>, <span class="st">""</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>            .<span class="bu">str</span>.replace(<span class="st">"</span><span class="ch">\n\n</span><span class="st">Content: "</span>, <span class="st">":  "</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>            .sample(rev_per_cluster, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>            .values</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Send the prompt to the API, with the reviews</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This is very conceptually similar to simply pasting the prompt and reviews into ChatGPT</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.completions.create(</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"text-davinci-003"</span>, <span class="co"># choose which model to use</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>            prompt<span class="op">=</span><span class="ss">f'What do the following customer reviews have in common?</span><span class="ch">\n\n</span><span class="ss">Customer reviews:</span><span class="ch">\n</span><span class="ss">"""</span><span class="ch">\n</span><span class="sc">{</span>reviews<span class="sc">}</span><span class="ch">\n</span><span class="ss">"""</span><span class="ch">\n\n</span><span class="ss">Theme:'</span>,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="dv">0</span>, <span class="co"># parameters for the model - this results in a deterministic, non-creative response</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>            top_p<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>            frequency_penalty<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>            presence_penalty<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        summary_dict[i<span class="op">+</span><span class="dv">1</span>][<span class="st">"theme"</span>] <span class="op">=</span> response.choices[<span class="dv">0</span>].text.replace(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="st">""</span>) <span class="co"># save the theme</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">#&nbsp;Also save the sampled reviews</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        sample_cluster_rows <span class="op">=</span> df[df[<span class="st">"Cluster"</span>] <span class="op">==</span> i].sample(rev_per_cluster, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        samp_dict <span class="op">=</span> {} <span class="co">#&nbsp;create a dictionary to save the sampled reviews</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(rev_per_cluster):</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> sample_cluster_rows[<span class="st">"Score"</span>].values[j] <span class="co"># get the score</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>            summary <span class="op">=</span> sample_cluster_rows[<span class="st">"Summary"</span>].values[j] <span class="co"># get the summary</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>            text <span class="op">=</span> sample_cluster_rows[<span class="st">"Text"</span>].values[j] <span class="co"># get the text</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>            samp_dict[j] <span class="op">=</span> (score, summary, text) <span class="co"># save the sampled review</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># save the sampled reviews</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        summary_dict[i<span class="op">+</span><span class="dv">1</span>][<span class="st">"samples"</span>] <span class="op">=</span> samp_dict</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the results to disk</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"data/summary_dict.pkl"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>        pickle.dump(summary_dict, f)</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>: <span class="co"># alternatively, load the results from disk</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Loading existing summary dict</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"data/summary_dict.pkl"</span>, <span class="st">"rb"</span>) <span class="im">as</span> f:</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>        summary_dict <span class="op">=</span> pickle.load(f)</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_clusters): <span class="co"># for each cluster</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cluster </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> Theme:"</span>, end<span class="op">=</span><span class="st">" "</span>)</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(summary_dict[i<span class="op">+</span><span class="dv">1</span>][<span class="st">"theme"</span>]) <span class="co"># print the theme</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(summary_dict[i<span class="op">+</span><span class="dv">1</span>][<span class="st">"samples"</span>])): <span class="co"># for each sampled review</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>        score, summary, text <span class="op">=</span> summary_dict[i<span class="op">+</span><span class="dv">1</span>][<span class="st">"samples"</span>][j] <span class="co"># get the score, summary, and text</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>score<span class="sc">}</span><span class="ss">/5 </span><span class="sc">{</span>summary<span class="sc">}</span><span class="ss">:   </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">"</span>[:<span class="dv">97</span>] <span class="op">+</span> <span class="st">"..."</span>) <span class="co"># print the sampled review</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">100</span>) <span class="co"># print a line break</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading existing summary dict

Cluster 1 Theme:  All of the reviews are discussing food or drink products.
3/5 Just ok:   I bought this brand because it was all they had at Ranch 99 near us. I find it spi...
5/5 Makes me drool just thinking of them:   The Brit's have out done us. The flavor is supreme,th...
5/5 Delicious way to flavour water naturally without too many calories:   I love the Flavrz range...
1/5 Couldn't tell you how it tasted:   The bottle was not sealed, and when I opened the cover, th...
5/5 Great tasting:   This is awesome salt. I buy it over and over as I just love the maltiness fl...
----------------------------------------------------------------------------------------------------
Cluster 2 Theme:  All of the reviews are about pet food.
2/5 Messy and apparently undelicious:   My cat is not a huge fan. Sure, she'll lap up the gravy, ...
4/5 The cats like it:   My 7 cats like this food but it is a little yucky for the human. Pieces o...
5/5 cant get enough of it!!!:   Our lil shih tzu puppy cannot get enough of it. Everytime she see...
1/5 Food Caused Illness:   I switched my cats over from the Blue Buffalo Wildnerness Food to this...
5/5 My furbabies LOVE these!:   Shake the container and they come running. Even my boy cat, who i...
----------------------------------------------------------------------------------------------------
Cluster 3 Theme:  All of the reviews are positive and complimentary of the product.
5/5 Twinings---a good cup of tea:   I have been drinking Twining's tea for years.  It used to be ...
5/5 Delish!!:   So yummy... Drinking it Black coffee or w cream this coffee is delish .... One of...
5/5 Excellent Tea:   This is the best tea i have had yet. It reminds me of a fine wine,very smoot...
5/5 Just like the Restaurant...:   This is great tasting tea! It tastes just like the tea at the ...
5/5 Rodeo Drive is Crazy Good Coffee!:   Rodeo Drive is my absolute favorite and I'm ready to ord...
----------------------------------------------------------------------------------------------------
Cluster 4 Theme:  All of the reviews are positive and discuss the quality of the product.
4/5 Yummy &amp; Great Small Gift:   If someone who will remain nameless would stop eating all mine, t...
3/5 The Kind Plus item was sticky:   I have no complaint about the product itself. I likely would...
3/5 The Kind Plus item was sticky:   I have no complaint about the product itself. I likely would...
4/5 yummy cookies!:   We've ordered for them every month and only once the package inside the sea...
5/5 BEST:   Okay so I work at a Family Dollar in St. Louis &amp;&amp; we just got these in. Well for awhi...
----------------------------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>It’s important to note that clusters will not necessarily match what you intend to use them for. A larger amount of clusters will focus on more specific patterns, whereas a small number of clusters will usually focus on largest discrepencies in the data.</p>
<p>Nevertheless, the simple <code>text-davinci-003</code> model with 5 reviews has identified some meaning from the data. Most notably is the distinct cluster 2, which contains reviews about pet food.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We have shown how to use the OpenAI API to generate embeddings for a dataset of food reviews. We have then used our machine to reduce the dimensionality of the embeddings, visualise them, and cluster them. Finally, we have used the OpenAI API again to summarise the clusters we have found.</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>np <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>size <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>plist <span class="op">=</span> [<span class="dv">1</span>]<span class="op">*</span>np <span class="op">+</span> [<span class="dv">0</span>]<span class="op">*</span>(size<span class="op">-</span>np)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>plist <span class="op">*=</span><span class="dv">10</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>actual <span class="op">=</span> random.sample(plist, <span class="bu">len</span>(plist))</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>preddec <span class="op">=</span> [random.random() <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(plist))]</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>preddec2 <span class="op">=</span> [x<span class="op">*</span>(y<span class="op">+</span>random.random())<span class="op">/</span><span class="dv">2</span> <span class="cf">for</span> x,y <span class="kw">in</span> <span class="bu">zip</span>(preddec, actual)]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> [<span class="dv">1</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="dv">0</span> <span class="cf">for</span> x <span class="kw">in</span> preddec]</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>pred2 <span class="op">=</span> [<span class="dv">1</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="dv">0</span> <span class="cf">for</span> x <span class="kw">in</span> preddec2]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">2</span><span class="op">*</span>x<span class="op">*</span>y<span class="op">/</span>(x<span class="op">+</span>y) <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(precision, recall)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/3m/k3bhjj_54975gvpvvrkv8x6w0000gn/T/ipykernel_17921/3406121630.py:1: RuntimeWarning: invalid value encountered in scalar divide
  max([2*x*y/(x+y) for x, y in zip(precision, recall)])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>0.3336951983298539</code></pre>
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> precision_score, recall_score, f1_score, accuracy_score, precision_recall_curve, auc</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>precision, recall, thresholds <span class="op">=</span> precision_recall_curve(actual, preddec)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>precision2, recall2, thresholds2 <span class="op">=</span> precision_recall_curve(actual, preddec2)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>plt.plot(recall, precision)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>plt.plot(recall2, precision2)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>plt.plot(recall, [<span class="dv">2</span><span class="op">*</span>x<span class="op">*</span>y<span class="op">/</span>(x<span class="op">+</span>y) <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(precision, recall)])</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>plt.plot(recall2, [<span class="dv">2</span><span class="op">*</span>x<span class="op">*</span>y<span class="op">/</span>(x<span class="op">+</span>y) <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(precision2, recall2)])</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Precision:"</span>, precision_score(actual, pred))</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Recall:"</span>, recall_score(actual, pred))</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"F1:"</span>, f1_score(actual, pred))</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"AUC"</span>, auc(recall, precision))</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Precision:"</span>, precision_score(actual, pred2))</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Recall:"</span>, recall_score(actual, pred2))</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"F1:"</span>, f1_score(actual, pred2))</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"AUC"</span>, auc(recall2, precision2))</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/3m/k3bhjj_54975gvpvvrkv8x6w0000gn/T/ipykernel_17921/2777967723.py:8: RuntimeWarning: invalid value encountered in scalar divide
  plt.plot(recall, [2*x*y/(x+y) for x, y in zip(precision, recall)])</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Precision: 0.19257305194805194
Recall: 0.4745
F1: 0.2739607390300231
AUC 0.1957720018395393
Precision: 1.0
Recall: 0.2855
F1: 0.4441851419681058
AUC 0.6782895849206549</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="openai-api-demo_files/figure-html/cell-16-output-3.png" class="img-fluid"></p>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>